<!-- {{{ start -->

<HTML><HEAD>
<TITLE>TBSS - Tract-Based Spatial Statistics</TITLE>
</HEAD><BODY BACKGROUND="../images/fsl-bg.jpg">
<hr><TABLE BORDER=0 WIDTH="100%"><TR>
<TD ALIGN=CENTER><H1>TBSS - Tract-Based Spatial Statistics - v1.0</H1>

Voxelwise analysis of multi-subject diffusion data<br><br>

<a href="#intro">Intro</a> &nbsp;&nbsp;-&nbsp;&nbsp;
<a href="#overview">Running TBSS</a> &nbsp;&nbsp;-&nbsp;&nbsp;
<a href="#nonFA">Using non-FA images in TBSS</a>

<TD ALIGN=RIGHT><a href="../index.html"><IMG BORDER=0 SRC="../images/fsl-logo.jpg"></a>
</TR></TABLE>

<!-- }}} -->
<!-- {{{ Introduction -->

<a name="intro"></a><p><hr><H2>Introduction</H2>

<p>There has been much recent interest in using magnetic resonance
diffusion imaging to provide information about anatomical connectivity
in the brain, by measuring the anisotropic diffusion of water in white
matter tracts. One of the measures most commonly derived from
diffusion data is fractional anisotropy (FA), which quantifies how
strongly directional the local tract structure is. Many imaging
studies are starting to use FA images in voxelwise statistical
analyses, in order to localise brain changes related to development,
degeneration and disease. However, optimal analysis is compromised by
the use of standard registration algorithms; there has not been a
satisfactory solution to the question of how to align FA images from
multiple subjects in a way that allows for valid conclusions to be
drawn from the subsequent voxelwise analysis.  Furthermore, the
arbitrariness of the choice of spatial smoothing extent has not been
resolved. TBSS aims to solve these issues via a) carefully tuned
nonlinear registration, followed by b) projection onto an
alignment-invariant tract representation (the "mean FA
skeleton"). TBSS aims to improve the sensitivity, objectivity and
interpretability of analysis of multi-subject diffusion imaging
studies.

<p>For more information on TBSS, including a technical report, see
the <A HREF="http://www.fmrib.ox.ac.uk/analysis/research/tbss/">TBSS
web page</A>. If you use TBSS in your research, please make sure that
you reference at least the first of the articles listed below, and
ideally the complete list.

<hr><b>Referencing TBSS</b>

<p><i>Brief summary text:</i> Voxelwise statistical analysis of the FA
data was carried out using TBSS (Tract-Based Spatial Statistics,
[Smith 2006]), part of FSL [Smith 2004]. TBSS projects all subjects'
FA data onto a mean FA tract skeleton, before applying voxelwise
cross-subject statistics.

<p><i>More detailed summary text:</i> Voxelwise statistical analysis
of the FA data was carried out using TBSS (Tract-Based Spatial
Statistics, [Smith 2006]), part of FSL [Smith 2004]. First, FA images
are created by fitting the diffusion tensor to the raw diffusion data
using FDT, and then brain-extracted using BET [Smith 2002]. All
subjects' FA data are then aligned into a common space using the
nonlinear registration IRTK [Rueckert 1999,
www.doc.ic.ac.uk/~dr/software]. The mean FA image is then created and
thinned to create a mean FA skeleton which represents the centres of
all tracts common to the group. Each subject's aligned FA data is then
projected onto this skeleton and the resulting data is fed into
voxelwise cross-subject statistics.

<font size=-1><em>

<p>[Smith 2006] S.M. Smith, M.&nbsp;Jenkinson, H.&nbsp;Johansen-Berg, D.&nbsp;Rueckert, T.E. Nichols, C.E. Mackay, K.E. Watkins, O.&nbsp;Ciccarelli, M.Z. Cader, P.M. Matthews, and T.E.J. Behrens.
<BR>&nbsp;&nbsp;&nbsp;Tract-based spatial statistics: Voxelwise analysis of multi-subject diffusion data.
<BR>&nbsp;&nbsp;&nbsp;NeuroImage, in press, 2006.

<p>[Smith 2004] S.M. Smith, M.&nbsp;Jenkinson, M.W. Woolrich, C.F. Beckmann, T.E.J. Behrens, H.&nbsp;Johansen-Berg, P.R. Bannister, M.&nbsp;De&nbsp;Luca, I.&nbsp;Drobnjak, D.E. Flitney, R.&nbsp;Niazy, J.&nbsp;Saunders, J.&nbsp;Vickers, Y.&nbsp;Zhang, N.&nbsp;De&nbsp;Stefano, J.M. Brady, and P.M. Matthews.
<BR>&nbsp;&nbsp;&nbsp;Advances in functional and structural MR image analysis and implementation as FSL.
<BR>&nbsp;&nbsp;&nbsp;NeuroImage, 23(S1):208-219, 2004.

<P>[Smith 2002] S.M. Smith.
<BR>&nbsp;&nbsp;&nbsp;Fast robust automated brain extraction.
<BR>&nbsp;&nbsp;&nbsp;Human Brain Mapping, 17(3):143-155, November 2002.

<P>[Rueckert 1999] D. Rueckert, L. I. Sonoda, C. Hayes, D. L. G. Hill, M. O. Leach, and D. J. Hawkes.
<BR>&nbsp;&nbsp;&nbsp;Non-rigid registration using free-form deformations: Application to breast MR images.
<BR>&nbsp;&nbsp;&nbsp;IEEE Transactions on Medical Imaging, 18(8):712-721, 1999.

</em></font>

<!-- }}} -->
<!-- {{{ overvew -->

<a name="overview"></a><p><hr><H2>Running TBSS - Overview</H2>

<p>Running TBSS first involves running a few simple steps/scripts:

<UL>

<LI><b>dtifit</b> - create FA images from your diffusion study data

<LI><b>tbss_1_preproc</b> - prepare your FA data in your TBSS working
  directory in the right format

<LI><b>tbss_2_reg</b> - apply nonlinear registration of all FA images into standard space

<LI><b>tbss_3_postreg</b> - create the mean FA image and skeletonise it

<LI><b>tbss_4_prestats</b> - project all subjects' FA data onto the mean FA skeleton

<LI><b>stats (e.g., randomise)</b> - feed the 4D projected FA data
  into GLM modelling and thresholding in order to find voxels which
  correlate with your model.

</UL>

<!-- }}} -->
<!-- {{{ details -->

We now go through the TBSS steps in detail.

<!-- {{{ 0 - creating FA data from a DTI/DWI study -->

<a name="0"></a><hr><h3>0 - creating FA data from a DTI/DWI study</h3>

In order to run TBSS you need to create a single FA image from each
subject in the study. We recommend that you do this using
the <code>dtifit</code> tool in
the <a href="../fdt/index.html">FDT</a> FSL toolbox.

<!-- }}} -->
<!-- {{{ 1 - tbss_1_preproc -->

<a name="1"></a><hr><h3>1 - tbss_1_preproc</h3>

You now need to create a new, empty directory (folder) in which you will run
the TBSS analysis, for example:

<pre>mkdir mytbss</pre>

Then copy into there all of your subjects' FA images, giving each
subject's FA image a different name, for example resulting in:

<pre>cd mytbss
ls
  CON_N00300_dti_data_FA.nii.gz
  CON_N00302_dti_data_FA.nii.gz
  CON_N00499_dti_data_FA.nii.gz
  PAT_N00373_dti_data_FA.nii.gz
  PAT_N00422_dti_data_FA.nii.gz
  PAT_N03600_dti_data_FA.nii.gz</pre>

You are now nearly ready to run the first TBSS script, which will
scale the FA values to be between 0 and 10000 and convert the format
to uncompressed Analyze with positive voxel dimensions (because the
nonlinear registration software IRTK requires this format). Before
running the first TBSS script, you need to know approximately what the
values in your FA data are (e.g. roughly in the range 0:1). If you
created your FA data using dtifit in FDT then the data will indeed be
roughly in the range 0:1. You can check this, for example, by:

<pre>avwstats CON_N00300_dti_data_FA -R
 0.000000 1.148992</pre>

If the range is close to 0:1 then the scaling applied by default by
the first TBSS script (10000) is already correct. Otherwise, you need
to tell the script what scaling to apply; for example, if your data is
in the range 0:1000 then you need a scaling of 10, etc. Now run the
script, from inside your working TBSS directory:

<pre><b>tbss_1_preproc</b></pre>

or, if you want to apply scaling &lt;SCALE&gt;, instead type:

<pre>tbss_1_preproc &lt;SCALE&gt;</pre>

The script will now scale and convert the data, placing it in a
newly-created sub-directory called <code>FAi</code>. It will also create
a sub-directory called <code>origdata</code> and place all your original
images in there for posterity.

At this point you can move onto the next script, but first it is
probably worth checking the images as created in FAi. A quick way of
doing this is with <code>slicesdir</code>, which allows you to create an
overview webpage of a series of images, for quick checking of them
all: type

<pre>slicesdir FAi/*.hdr</pre>

When it finishes running it gives you a link to open in a web browser
to see quick views of all images, for checking that they look
reasonable.

<p>Note that the first 3 TBSS scripts (tbss_1_preproc, tbss_2_reg and
tbss_3_postreg must all be run on computers of the same "type"
(e.g. all 32-bit linux, or all 64-bit Apple); this is because the
files used by the IRTK registration software don't always work the
same on different computer hardware.

<!-- }}} -->
<!-- {{{ 2 - tbss_2_reg -->

<a name="2"></a><hr><h3>2 - tbss_2_reg</h3>

The next TBSS script runs the nonlinear registration, aligning all FA
images to a 1x1x1mm standard space. The default behaviour of the
script is to align every FA image to every other one, identify the
"most representative" one, and use this as the target image. This
target image is then affine-aligned into MNI152 standard space, and
every image is transformed into 1x1x1mm MNI152 space by combining the
nonlinear transform to the target FA image with the affine transform
from that target to MNI152 space.

<p>By default, therefore, this process can take a <b>very</b> long
  time, as you will have NxN nonlinear alignments, each of which can
  take 30 minutes or more on a typical computer. There are two ways of
  speeding this up - use multiple computers, and/or pre-specify which
  FA image to use as the target, in which case you just need N
  alignments.

<p>To just run the script in default mode, type:

<pre><b>tbss_2_reg</b></pre>

<p>Don't worry about warnings that say "<code>Final transformation
ERROR:: Empty image</code>" - these occur when the script is
registering an image to itself.

<p><b>Running in parallel on multiple computers</b>

<p>If you have several computers that you can run the registration on,
  this is straightforward as long as they can all see the working data
  directory and are all of the same "type" (e.g. all 32-bit linux, or
  all 64-bit Apple); this is because the files used by the IRTK
  registration software don't always work the same on different
  computer hardware. In order to use multiple computers, simply log on
  to each (in a separate terminal window for each), <code>cd</code> to
  the TBSS working directory, and run the <code>tbss_2_reg</code>
  script. Each time the script is run it looks for registrations which
  still need running and, one at a time, runs those which haven't yet
  been done. Note that if you have computers with more than one CPU,
  you can open as many terminals as you have CPUs, and run the script
  in each one.

<p>Once <b>all</b> the scripts have finished running, you are ready to
  move onto the next step.

<p>Alternatively, if your lab has a batch submission system (e.g.,
  SGE) then you may want to amend the TBSS script to take advantage of
  this - then all the registration jobs get submitted to the batch
  system for optimal processing. In this case, ask your system
  administrator to edit $FSLDIR/bin/tbss_2_reg and possibly edit the
  two lines starting with the one testing for "SGE_ROOT", in order to
  make the necessary submission to your batch system. In this case you
  only need to run the TBSS script once; this submits all the
  registrations to your batch system, and you need to watch for them
  all to complete before moving on to the next stage of TBSS.

<p><b>Running with a pre-specified target FA image</b>

<p>The other thing you can do if you want to speed up the
  registrations is to pre-specify the target FA image, in which case
  you just have to run a single registration for each subject's FA
  image, i.e. each to the specified target. You also might choose to
  do this if for any other reason you have a particular wish to
  specify the target. We supply an example good quality target FA
  image with TBSS - it can be found
  in <code>$FSLDIR/etc/standard/example_FA_target</code>. To tell the
  TBSS registration script to use a target, copy the desired file into
  the FAi subdirectory in uncompressed Analyze format, calling
  it <code>target.hdr / target.img</code> and then run the
  registration script. (This target does not already need to be in
  standard space - that will be taken care of for you.) For example:

<pre>export FSLOUTPUTTYPE=ANALYZE
avwmaths_16SI $FSLDIR/etc/standard/example_FA_target FAi/target
tbss_2_reg</pre>

<p>In this case the script will just register each subject's FA to the
  chosen target.

<!-- }}} -->
<!-- {{{ 3 - tbss_3_postreg -->

<a name="3"></a><hr><h3>3 - tbss_3_postreg</h3>

<p>The next TBSS script starts by deciding which of your FA images is the
most "typical", for selection as the target image to apply all
nonlinear transformations into the space of. (The script does this by
taking each FA image in turn, and estimating the average amount of
warping that was necessary to align all other images to it; it then
finds the one that had the smallest amount of average warping when
used as a target.) Obviously if you pre-specified the FA target image
then this step is automatically skipped.

<p>The script then takes the target and affine-aligns it into 1x1x1mm
  MNI152 space - this resolution is chosen as the later
  skeletonisation and projection steps work well at this resolution,
  and the choice of working in MNI152 space is chosen for convenience
  of display and coordinate reporting later. Once this is done, each
  subject's FA image has the nonlinear transform to the target and
  then the affine transform to MNI152 space applied, resulting in a
  transformation of the original FA image into MNI152 space (actually
  the two transformations are combined before being applied, to avoid
  having to resample the image twice).

<p>This results in a standard-space version of each subject's FA
  image; next these are all merged into a single 4D image file
  called <code>all_FA</code>, created in a new subdirectory
  called <code>stats</code>. Next, the mean of all FA images is
  created, called <code>mean_FA</code>, and this is then fed into the
  FA skeletonisation program to create <code>mean_FA_skeleton</code>.

<p>All of the above is done simply by running the script:

<pre><b>tbss_3_postreg</b></pre>

<p>This finishes by reminding you to check whether a suitable
  threshold for the mean FA skeleton is 2000 (i.e., mean FA of 0.2 in
  the skeleton - the default used by the next script). For example,
  load the 4D FA data and the skeleton into FSLView:

<pre>cd stats
fslview all_FA mean_FA_skeleton</pre>

<p>Then change the colourmap for the skeleton to say Red-Yellow, and
  set its display range to be 2000:8000. Now turn on the movie loop;
  you will see the mean FA skeleton on top of each different subject's
  aligned FA image. If all the processing so far has worked ok the
  skeleton should look like the examples shown in the TBSS paper. If
  the registration has worked well you should see that in general each
  subject's major tracts are reasonably well aligned to the relevant
  parts of the skeleton. If you set the skeleton threshold (in
  FSLView, the lower of the display range settings) much lower than
  2000, it will extend away towards extremes where there is too much
  cross-subject variability and where the nonlinear registration has
  not been able to attain good alignments.

<!-- }}} -->
<!-- {{{ 4 - tbss_4_prestats -->

<a name="4"></a><hr><h3>4 - tbss_4_prestats</h3>

<p>The last TBSS script carries out the final steps necessary before
  you run the voxelwise cross-subject stats. It thresholds the mean FA
  skeleton image at the chosen threshold - it defaults to 2000 if you
  do not tell it an alternative one to use - hence either type:

<pre><b>tbss_4_prestats</b></pre>

or, if you want an alternative threshold &lt;THRESH&gt;, type:

<pre>tbss_4_prestats &lt;THRESH&gt;</pre>

<p>The resulting binary skeleton mask defines the set of voxels used
  in all subsequent processing. Next a "distance map" is created from
  the skeleton mask. This is used in the projection of FA onto the
  skeleton (see the TBSS paper for more detail). Finally, the script
  takes the 4D FA image (containing all subjects' aligned FA data)
  and, for each "timepoint" (i.e., subject ID), projects the FA data
  onto the mean FA skeleton. This results in a 4D image file
  containing the (projected) skeletonised FA data. It is this file
  that you will feed into voxelwise statistics in the next, final,
  section.

<!-- }}} -->
<!-- {{{ 5 - voxelwise statistics on the skeletonised FA data -->

<a name="5"></a><hr><h3>5 - voxelwise statistics on the skeletonised FA data</h3>

<p>The previous step resulted in the 4D skeletonised FA
  image <code>all_FA_skeletonised</code> (in the <code>stats</code>
  subdirectory). It is this that you now feed into voxelwise
  statistics, that, for example, tells you which FA skeleton voxels
  are significantly different between two groups of subjects.

<p>One recommended way of doing the stats is to use
  the <code>randomise</code> tool. For more detail see
  the <a href="../randomise/index.html">randomise manual</a>. Before
  running <code>randomise</code> you will need to generate a design
  matrix file, e.g., <code>design.mat</code> and contrasts file,
  e.g., <code>design.con</code>. You can use the
  script <code>design_ttest2</code> in the simple case of a two-group
  comparison. Alternatively you can use the <b>Glm</b> GUI to generate
  these design matrix and contrast files. Note that the order of the
  entries (rows) in your design matrix <i>must</i> match the
  alphabetical order of your original FA images, as that determines
  the order of the aligned FA images in the final 4D
  file <code>all_FA_skeletonised</code>; check this with:

<pre>
cd FAi
ls -1 *FAi.hdr
</pre>

<p>For example, say you have 7 controls (with original filenames
  <code>CON_001_dti_FA.nii.gz</code> etc.) and 11 patients (with
  original filenames <code>PAT_001_dti_FA.nii.gz</code> etc.). You can
  generate design files and run voxelwise statistics and inference
  using randomisation, including cluster-based thresholding, using:

<pre>
cd ../stats
design_ttest2 design 7 11

randomise -i all_FA_skeletonised -o tbss -m mean_FA_skeleton_mask -d design.mat -t design.con -n 5000 -c 3 -V

fslview MNI152 mean_FA_skeleton -l Green -b 2000,8000 tbss_tstat1 -l Red-Yellow -b 3,6 tbss_tstat2 -l Blue-Lightblue -b 3,6
</pre>

<p>In this case, contrast 1 gives the control&gt;patient test and
  contrast 2 gives the control&lt;patient test. The raw
  (unthresholded) tstat images are <code>tbss_tstat1</code>
  and <code>tbss_tstat2</code> respectively. The cluster p-value
  images (fully corrected for multiple comparisons across space)
  are <code>tbss_maxc_tstat1</code> and <code>tbss_maxc_tstat2</code>
  (note, these are actually 1-p for convenience of display, so
  thresholding at .95 gives significant clusters).

<!-- }}} -->

<!-- }}} -->
<!-- {{{ non-FA -->

<a name="nonFA"></a><p><hr><H2>Using non-FA Images in TBSS</H2>

<p>It is straightforward to apply TBSS to other diffusion-derived data
  than FA images. For example, you may be interested in how MD (mean
  diffusivity) or the first diffusion tensor eigenvalue varies between
  different subjects.

<p>To achieve this we recommend using the FA images to achieve the
  nonlinear registration and skeletonisation stages, and also to
  estimate the projection vectors from each individual subject onto
  the mean FA skeleton. The nonlinear warps and skeleton projection
  can then also be applied to other images such as the second
  eigenvalue. The following instructions assume that you want to run
  TBSS on the second eigenvalue, named L2 by dtifit:

<UL>

<LI>Run the full TBSS analysis (steps 0-4 above) on your FA data.

<LI>Create a new directory called L2 (or any other name) in your TBSS
  analysis directory (the one that contains the
  existing <code>origdata</code>, <code>FAi</code>
  and <code>stats</code> directories from the FA
  analysis):<br><code>mkdir L2</code>

<LI>Copy your L2 images into this new directory, making sure that they
  are named <b>exactly</b> the same as the original FA images were (look in
  <code>origdata</code> to check the original names).

<LI>Making sure that you are in the L2 directory,
  run <code>tbss_1_preproc</code>, using a sensible scaling argument
  (which in general will be different from <a href="#1">the scaling
  needed for the original FA data</a>):<br><code>cd L2 ;
  tbss_1_preproc 10</code>

<LI>Now go back up one directory to your top working TBSS directory
  and run the <code>tbss_non_FA</code> script, telling it that the
  alternate data is called L2. This will apply the
  original nonlinear registration to the L2 data, merge all subjects'
  warped L2 data into a 4D file <code>stats/all_L2</code>, project
  this onto the original mean FA skeleton (using the original FA data
  to find the projection vectors), resulting in the 4D projected
  data <code>stats/all_L2_projected</code>:<br><code>cd .. ;
  tbss_non_FA L2</code>

<LI>You can now run voxelwise stats on the projected 4D
  data <code>all_L2_skeletonised</code> <a href="#5">in the same
  manner as described above</a>.

</UL>

<!-- }}} -->
<!-- {{{ end -->

<p><HR><FONT SIZE=1>Copyright &copy; 2005-2006, University of
Oxford. Written by <A
HREF="http://www.fmrib.ox.ac.uk/~steve/index.html">S. Smith</A>.</FONT>

<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

</BODY></HTML>

<!-- }}} -->
